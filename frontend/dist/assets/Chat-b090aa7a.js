import{aB as P,r as k,c as Q,m as W,f as $,al as p,z as d,A as m,B as e,R as n,J as r,u as a,P as l,O as v,Q as R,a4 as b,M as q,I as A,a5 as G,D as B,n as X}from"./vendor-0413c596.js";import{b as Y,a as S,e as D,s as Z,f as ee,g as se,p as te}from"./element-a74229b3.js";import{u as j,a as oe,b as ne}from"./index-18f1411d.js";import{_ as ae}from"./_plugin-vue_export-helper-c27b6911.js";const re={class:"chat-container"},le={class:"chat-sidebar"},ce={class:"sidebar-header"},ie={class:"user-info"},de={class:"user-details"},ue={class:"user-status"},_e={class:"sidebar-content"},me={class:"room-section"},pe={class:"room-list"},ve=["onClick"],he={class:"online-section"},fe={class:"online-users"},ge={key:0,style:{color:"#999","font-size":"12px"}},ye={class:"chat-main"},we={class:"chat-header"},Ce={class:"connection-status"},ke={class:"message-avatar"},xe={class:"message-content"},Re={class:"message-header"},be={class:"message-username"},Be={class:"message-time"},Se={class:"message-text"},Me={class:"chat-input"},Ue={__name:"Chat",setup(ze){const E=P(),c=j(),i=oe(),_=ne(),h=k(""),y=k(!1),w=k(),M=k([{id:"general",name:"公共聊天室"},{id:"tech",name:"技术讨论"},{id:"random",name:"闲聊"}]),x=Q(()=>{const o=[...i.onlineUsers];return c.user&&!o.find(s=>s.id===c.user.id)&&o.unshift({id:c.user.id,username:c.user.username,avatar:c.user.avatar}),o});W(async()=>{await i.joinRoom("general"),_.connected||await _.connect()}),$(()=>i.messages.length,()=>{X(()=>{K()})});const K=()=>{w.value&&(w.value.scrollTop=w.value.scrollHeight)},O=()=>{const o=M.value.find(s=>s.id===i.currentRoom);return o?o.name:"未知房间"},F=async o=>{if(o!==i.currentRoom)try{_.leaveRoom(i.currentRoom),await i.joinRoom(o),_.joinRoom(o)}catch(s){console.error("切换房间失败:",s)}},U=async()=>{if(!(!h.value.trim()||y.value)){y.value=!0;try{const o=h.value.trim(),s=j(),f={id:Date.now().toString(),user_id:s.user.id,username:s.user.username,content:o,message_type:"text",room_id:i.currentRoom,timestamp:Math.floor(Date.now()/1e3),is_temp:!0};i.addMessage(f),h.value="",_.sendChatMessage(o,"text")}catch{S.error("发送失败，请重试")}finally{y.value=!1}}},H=async o=>{switch(o){case"profile":S.info("个人资料功能开发中...");break;case"logout":try{await Y.confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),_.disconnect(),c.logout(),E.push("/login"),S.success("已退出登录")}catch{}break}};return(o,s)=>{var T,N;const f=p("el-avatar"),C=p("el-icon"),z=p("el-button"),V=p("el-dropdown-item"),I=p("el-dropdown-menu"),J=p("el-dropdown"),L=p("el-input");return d(),m("div",re,[e("div",le,[e("div",ce,[e("div",ie,[n(f,{src:(T=a(c).user)==null?void 0:T.avatar,size:40},{default:r(()=>{var t,u;return[v(l((u=(t=a(c).user)==null?void 0:t.username)==null?void 0:u.charAt(0).toUpperCase()),1)]}),_:1},8,["src"]),e("div",de,[e("h3",null,l((N=a(c).user)==null?void 0:N.username),1),e("p",ue,[n(C,null,{default:r(()=>[n(a(D))]),_:1}),s[1]||(s[1]=v(" 在线 ",-1))])])]),n(J,{onCommand:H},{dropdown:r(()=>[n(I,null,{default:r(()=>[n(V,{command:"profile"},{default:r(()=>[...s[2]||(s[2]=[v("个人资料",-1)])]),_:1}),n(V,{command:"logout",divided:""},{default:r(()=>[...s[3]||(s[3]=[v("退出登录",-1)])]),_:1})]),_:1})]),default:r(()=>[n(z,{type:"text",icon:a(Z)},null,8,["icon"])]),_:1})]),e("div",_e,[e("div",me,[s[4]||(s[4]=e("h4",null,"聊天房间",-1)),e("div",pe,[(d(!0),m(R,null,b(M.value,t=>(d(),m("div",{key:t.id,class:B(["room-item",{active:a(i).currentRoom===t.id}]),onClick:u=>F(t.id)},[n(C,null,{default:r(()=>[n(a(ee))]),_:1}),e("span",null,l(t.name),1)],10,ve))),128))])]),e("div",he,[e("h4",null,"在线用户 ("+l(x.value.length)+")",1),e("div",fe,[(d(!0),m(R,null,b(x.value,t=>{var u;return d(),m("div",{key:t.id,class:B(["online-user",{"current-user":t.id===((u=a(c).user)==null?void 0:u.id)}])},[n(f,{src:t.avatar,size:24},{default:r(()=>{var g;return[v(l((g=t.username)==null?void 0:g.charAt(0).toUpperCase()),1)]}),_:2},1032,["src"]),e("span",null,l(t.username),1),s[5]||(s[5]=e("div",{class:"online-indicator"},null,-1))],2)}),128)),x.value.length===0?(d(),m("div",ge," 暂无在线用户 ")):q("",!0)])])])]),e("div",ye,[e("div",we,[e("h2",null,l(O()),1),e("div",Ce,[a(_).connected?(d(),A(C,{key:0,color:"#67c23a"},{default:r(()=>[n(a(D))]),_:1})):(d(),A(C,{key:1,color:"#f56c6c"},{default:r(()=>[n(a(se))]),_:1})),e("span",null,l(a(_).connected?"已连接":"连接中..."),1)])]),e("div",{class:"chat-messages",ref_key:"messagesContainer",ref:w},[(d(!0),m(R,null,b(a(i).messages,t=>{var u;return d(),m("div",{key:t.id,class:B(["message-item",{"own-message":t.user_id===((u=a(c).user)==null?void 0:u.id)}])},[e("div",ke,[n(f,{size:32},{default:r(()=>{var g;return[v(l((g=t.username)==null?void 0:g.charAt(0).toUpperCase()),1)]}),_:2},1024)]),e("div",xe,[e("div",Re,[e("span",be,l(t.username),1),e("span",Be,l(t.timestamp),1)]),e("div",Se,l(t.content),1)])],2)}),128))],512),e("div",Me,[n(L,{modelValue:h.value,"onUpdate:modelValue":s[0]||(s[0]=t=>h.value=t),placeholder:"输入消息...",size:"large",onKeyup:G(U,["enter"])},{append:r(()=>[n(z,{type:"primary",icon:a(te),loading:y.value,onClick:U},{default:r(()=>[...s[6]||(s[6]=[v(" 发送 ",-1)])]),_:1},8,["icon","loading"])]),_:1},8,["modelValue"])])])])}}},De=ae(Ue,[["__scopeId","data-v-b2056503"]]);export{De as default};
